# Azure Pipelines YAML for MuleSoft Projects
# âœ… Maven 3.9.10 (multi-mirror installation)
# âœ… Java 17
# âœ… SonarQube Analysis
# âœ… API Governance Validation
# âœ… MUnit Tests (COMMENTED OUT)
# âœ… CloudHub Deployment (COMMENTED OUT)

trigger:
  branches:
    include:
      - '*'

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: build.variables
  - name: disable.coverage.autogenerate
    value: 'true'
  - name: MAVEN_VERSION
    value: '3.9.10'
  - name: MAVEN_CACHE_FOLDER
    value: $(Pipeline.Workspace)/.m2/repository
  - name: MAVEN_OPTS
    value: '-Xmx3072m'
  - name: MAVEN_OPTS_BUILD
    value: '-Dsecure.key=mule -Dmule.env=dev -DskipTests'
  - name: MAVEN_OPTS_TEST_MUNIT
    value: '-Dsecure.key=mule -Dmule.env=dev -Dproject.version=1.0.0'
  - name: PROJECT_NAME
    value: $[variables.projectName]
  - name: ANYPOINT_USERNAME
    value: $[variables.anypointUsername]
  - name: ANYPOINT_PASSWORD
    value: $[variables.anypointPassword]
  - name: MULE_ORG
    value: $[variables.muleOrg]
  - name: MULE_ORG_ID
    value: $[variables.muleOrgId]

steps:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 1: Setup Java 17
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - task: JavaToolInstaller@0
    displayName: 'Setup Java 17'
    inputs:
      versionSpec: '17'
      jdkArchitectureOption: 'x64'
      jdkSourceOption: 'PreInstalled'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 2: Install Maven 3.9.10 (Multi-Mirror Fallback)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - script: |
      set -e
      echo "ğŸ”§ Installing Maven 3.9.10 (REQUIRED for Mule Maven Plugin 4.6.0)"
      echo ""
      
      # Clean up any existing installations
      sudo rm -rf /opt/maven /usr/share/maven 2>/dev/null || true
      
      # Define multiple mirror URLs (in order of preference)
      MIRRORS=(
        "https://dlcdn.apache.org/maven/maven-3/3.9.10/binaries/apache-maven-3.9.10-bin.tar.gz"
        "https://downloads.apache.org/maven/maven-3/3.9.10/binaries/apache-maven-3.9.10-bin.tar.gz"
        "https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.10/apache-maven-3.9.10-bin.tar.gz"
        "https://archive.apache.org/dist/maven/maven-3/3.9.10/binaries/apache-maven-3.9.10-bin.tar.gz"
        "https://mirrors.estointernet.in/apache/maven/maven-3/3.9.10/binaries/apache-maven-3.9.10-bin.tar.gz"
        "https://mirror.cc.columbia.edu/pub/software/apache/maven/maven-3/3.9.10/binaries/apache-maven-3.9.10-bin.tar.gz"
      )
      
      SUCCESS=0
      
      for mirror in "${MIRRORS[@]}"; do
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ”„ Trying mirror: $mirror"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        if curl -fsSL --connect-timeout 10 --max-time 120 --retry 2 \
           -o /tmp/maven.tar.gz "$mirror" 2>&1; then
          
          if [ -f /tmp/maven.tar.gz ]; then
            FILE_SIZE=$(stat -c%s /tmp/maven.tar.gz)
            echo "âœ… Download successful: $FILE_SIZE bytes"
            
            if [ $FILE_SIZE -gt 8000000 ]; then
              echo "âœ… File size valid (> 8MB)"
              SUCCESS=1
              break
            else
              echo "âš ï¸  File too small, trying next mirror..."
              rm -f /tmp/maven.tar.gz
            fi
          fi
        else
          echo "âŒ Failed, trying next mirror..."
        fi
        echo ""
      done
      
      if [ $SUCCESS -eq 0 ]; then
        echo "âŒ ERROR: All mirrors failed!"
        exit 1
      fi
      
      echo "ğŸ“¦ Extracting Maven..."
      sudo mkdir -p /opt/maven
      sudo tar -xzf /tmp/maven.tar.gz -C /opt/maven --strip-components=1
      sudo chmod +x /opt/maven/bin/mvn
      
      INSTALLED_VERSION=$(/opt/maven/bin/mvn --version | grep "Apache Maven" | awk '{print $3}')
      echo "Installed version: $INSTALLED_VERSION"
      
      if [ "$INSTALLED_VERSION" = "3.9.10" ]; then
        echo "âœ… Maven 3.9.10 installation SUCCESSFUL"
      else
        echo "âŒ ERROR: Expected 3.9.10, got $INSTALLED_VERSION"
        exit 1
      fi
      
      rm -f /tmp/maven.tar.gz
      echo "ğŸ‰ Maven 3.9.10 ready!"
    displayName: 'Install Maven 3.9.10'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 3: Download settings.xml from Secure Files
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - task: DownloadSecureFile@1
    name: muleSettingsFile
    displayName: 'Download Mulesoft Settings'
    inputs:
      secureFile: 'settings.xml'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 4: Install settings.xml
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - script: |
      echo "ğŸ“¦ Installing settings.xml..."
      mkdir -p ~/.m2
      cp $(muleSettingsFile.secureFilePath) ~/.m2/settings.xml
      
      if [ ! -f ~/.m2/settings.xml ]; then
        echo "âŒ ERROR: settings.xml not found"
        exit 1
      fi
      
      echo "âœ… settings.xml installed: ~/.m2/settings.xml"
    displayName: 'Install Maven Settings'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 5: Install Anypoint CLI
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - script: |
      npm install -g anypoint-cli
    displayName: 'Install Anypoint CLI'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 6: API Governance Validation
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - script: |
      anypoint-cli --username=$(ANYPOINT_USERNAME) --password=$(ANYPOINT_PASSWORD) --organization='$(MULE_ORG)' governance api validate --rulesets ruleset.yaml $(PROJECT_NAME).zip
    displayName: 'API Governance Validation'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 7: Install ReportGenerator Tool
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - script: |
      dotnet tool install --tool-path tools dotnet-reportgenerator-globaltool --version 4.6.1
    displayName: 'Install ReportGenerator Tool'
    continueOnError: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 8: Cache Maven Dependencies
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - task: Cache@2
    inputs:
      key: 'maven | "$(Agent.OS)" | **/pom.xml'
      restoreKeys: |
        maven | "$(Agent.OS)"
        maven
      path: $(MAVEN_CACHE_FOLDER)
    displayName: 'Cache Maven Dependencies'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 9: SonarQube Prepare
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - task: SonarQubePrepare@7
    inputs:
      SonarQube: $(PROJECT_NAME)
      scannerMode: 'Other'
      extraProperties: |
        sonar.projectKey=$(PROJECT_NAME)_$(PROJECT_NAME)
    displayName: 'SonarQube Prepare'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 10: MUnit Test (COMMENTED OUT)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # - script: |
  #     export PATH=/opt/maven/bin:$PATH
  #     export MAVEN_OPTS="-Xmx3072m"
  #     
  #     echo "ğŸ§ª Running MUnit tests..."
  #     
  #     mvn test \
  #       -Dmaven.repo.local=$(MAVEN_CACHE_FOLDER) \
  #       -Dsecure.key=mule \
  #       -Dmule.env=dev \
  #       -Dproject.version=1.0.0
  #   displayName: 'MUnit Test'
  #   continueOnError: false

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 11: Maven Build with SonarQube Analysis
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - script: |
      export PATH=/opt/maven/bin:$PATH
      export MAVEN_OPTS="-Xmx3072m"
      
      echo "ğŸ”¨ Running Maven package with SonarQube analysis..."
      
      mvn clean package sonar:sonar \
        -Dmaven.repo.local=$(MAVEN_CACHE_FOLDER) \
        -Dsecure.key=mule \
        -Dmule.env=dev \
        -DskipTests
      
      echo "âœ… Build successful"
    displayName: 'Maven Build with SonarQube'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 12: SonarQube Publish
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - task: SonarQubePublish@7
    inputs:
      pollingTimeoutSec: '300'
    displayName: 'SonarQube Publish'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 13: Copy Build Artifacts
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - task: CopyFiles@2
    inputs:
      Contents: '**/target/*.jar'
      TargetFolder: $(Build.ArtifactStagingDirectory)
      CleanTargetFolder: true
      flattenFolders: true
    displayName: 'Copy Build Artifacts'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 14: Publish Test Results (Coverage Report)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - task: PublishTestResults@2
    displayName: 'Publish Test Results'
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: '**/surefire-reports/TEST-*.xml'
      mergeTestResults: true
      failTaskOnFailedTests: false
    continueOnError: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 15: Publish Pipeline Artifacts
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - task: PublishPipelineArtifact@1
    inputs:
      targetPath: $(Build.ArtifactStagingDirectory)
      artifact: 'drop'
    displayName: 'Publish Pipeline Artifacts'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STEP 16: Build Summary
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - script: |
      export PATH=/opt/maven/bin:$PATH
      
      echo ""
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "ğŸ‰ BUILD COMPLETED SUCCESSFULLY"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo ""
      echo "Artifacts:"
      ls -lh target/*.jar 2>/dev/null || echo "No artifacts in target/"
      ls -lh $(Build.ArtifactStagingDirectory)/*.jar 2>/dev/null || echo "No artifacts in staging"
      echo ""
      echo "Maven Version: $(mvn --version | grep "Apache Maven" | awk '{print $3}')"
      echo "Java Version: $(java -version 2>&1 | head -1)"
      echo "Project: $(PROJECT_NAME)"
      echo ""
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    displayName: 'Build Summary'
    condition: succeeded()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CLOUDHUB DEPLOYMENT (COMMENTED OUT)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 
# Uncomment the section below to enable CloudHub deployment:
#
# - script: |
#     export PATH=/opt/maven/bin:$PATH
#     export MAVEN_OPTS="-Xmx3072m"
#     
#     echo "ğŸš€ Deploying to CloudHub..."
#     
#     mvn deploy \
#       -Dmaven.repo.local=$(MAVEN_CACHE_FOLDER) \
#       -DskipTests \
#       -Dmule.version=4.9.0 \
#       -Dcloudhub.environment=Sandbox \
#       -Danypoint.username=$(ANYPOINT_USERNAME) \
#       -Danypoint.password=$(ANYPOINT_PASSWORD)
#     
#     echo "âœ… Deployment successful"
#   displayName: 'Deploy to CloudHub'
#   condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
# 
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
