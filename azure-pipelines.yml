trigger:
  branches:
    include:
      - main
      - master

pool:
  vmImage: ubuntu-latest

variables:
  MAVEN_OPTS: "-Xmx2g"

steps:

# ------------------------------------------------------
# 1️⃣ Checkout source
# ------------------------------------------------------
- checkout: self
  displayName: Checkout source code

# ------------------------------------------------------
# 2️⃣ Download Maven settings.xml from Secure Files
# ------------------------------------------------------
- task: DownloadSecureFile@1
  name: mulesoftSettings
  inputs:
    secureFile: settings.xml
  displayName: Download MuleSoft Maven settings.xml

# ------------------------------------------------------
# 3️⃣ Verify Java & Maven (debug-friendly)
# ------------------------------------------------------
- script: |
    java -version
    mvn -version
  displayName: Verify Java & Maven versions

# ------------------------------------------------------
# 4️⃣ Maven Clean Compile (with MuleSoft auth)
# ------------------------------------------------------
- script: |
    echo "Using Maven settings: $(mulesoftSettings.secureFilePath)"
    mvn -s $(mulesoftSettings.secureFilePath) clean compile
  displayName: Maven Clean Compile (Mule Application)

# ------------------------------------------------------
# 5️⃣ Maven Package (build Mule deployable)
# ------------------------------------------------------
- script: |
    mvn -s $(mulesoftSettings.secureFilePath) package
  displayName: Maven Package (Mule Application)

# ------------------------------------------------------
# 6️⃣ Publish build artifacts (optional but useful)
# ------------------------------------------------------
- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: target
    artifactName: mule-artifact
    publishLocation: Container
  displayName: Publish Mule Build Artifacts
