# Azure Pipelines YAML for MuleSoft Projects
# âœ… Maven 3.9.10 (exact version - manually installed)
# âœ… Java 17
# âœ… Mule Maven Plugin 4.6.0
# âœ… Connected App Bearer Token via settings.xml

trigger:
  branches:
    include:
      - '*'

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: build.variables
  - name: MAVEN_VERSION
    value: '3.9.10'
  - name: MAVEN_CACHE_FOLDER
    value: $(Pipeline.Workspace)/.m2/repository
  - name: MAVEN_OPTS
    value: '-Xmx3072m'

stages:
  - stage: Build
    displayName: 'Build and Test Stage'
    jobs:
      - job: BuildAndTest
        displayName: 'Build and Test Job'
        steps:
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # STEP 1: Setup Java 17
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          - task: JavaToolInstaller@0
            displayName: 'Setup Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # STEP 2: Install Maven 3.9.10 (Exact Version)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          - script: |
              set -e
              echo "ğŸ”§ Installing Maven 3.9.10 (exact version)..."
              echo ""
              
              # Show current Maven (will be replaced)
              echo "Current Maven (pre-installed):"
              mvn --version 2>/dev/null || echo "  Not found"
              echo ""
              
              # Clean up any existing installations
              sudo rm -rf /opt/maven /usr/share/maven 2>/dev/null || true
              
              # Download Maven 3.9.10 from Apache archive
              MAVEN_URL="https://archive.apache.org/dist/maven/maven-3/3.9.10/binaries/apache-maven-3.9.10-bin.tar.gz"
              
              echo "Downloading Maven 3.9.10..."
              echo "URL: $MAVEN_URL"
              
              # Try wget first, fallback to curl
              if command -v wget &> /dev/null; then
                wget --timeout=300 --tries=3 -O /tmp/maven.tar.gz "$MAVEN_URL"
              else
                curl -fsSL --connect-timeout 30 --max-time 300 --retry 3 -o /tmp/maven.tar.gz "$MAVEN_URL"
              fi
              
              # Verify download
              if [ ! -f /tmp/maven.tar.gz ]; then
                echo "âŒ ERROR: Download failed"
                exit 1
              fi
              
              FILE_SIZE=$(stat -c%s /tmp/maven.tar.gz)
              echo "âœ… Downloaded: $FILE_SIZE bytes"
              
              # Extract Maven
              echo ""
              echo "Extracting Maven..."
              sudo mkdir -p /opt/maven
              sudo tar -xzf /tmp/maven.tar.gz -C /opt/maven --strip-components=1
              
              # Set permissions
              sudo chmod +x /opt/maven/bin/mvn
              
              # Verify installation
              if [ ! -f /opt/maven/bin/mvn ]; then
                echo "âŒ ERROR: Maven binary not found after extraction"
                exit 1
              fi
              
              echo "âœ… Maven extracted successfully"
              echo ""
              
              # Verify version
              INSTALLED_VERSION=$(/opt/maven/bin/mvn --version | grep "Apache Maven" | awk '{print $3}')
              echo "Installed Maven version: $INSTALLED_VERSION"
              
              if [ "$INSTALLED_VERSION" = "3.9.10" ]; then
                echo "âœ… Version verification PASSED"
              else
                echo "âŒ ERROR: Expected 3.9.10, got $INSTALLED_VERSION"
                exit 1
              fi
              
              # Cleanup
              rm -f /tmp/maven.tar.gz
              
              echo ""
              echo "âœ… Maven 3.9.10 installation complete!"
            displayName: 'Install Maven 3.9.10'

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # STEP 3: Download settings.xml from Secure Files
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          - task: DownloadSecureFile@1
            name: mavenSettings
            displayName: 'Download settings.xml'
            inputs:
              secureFile: 'settings.xml'

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # STEP 4: Install settings.xml to ~/.m2/
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          - script: |
              echo "ğŸ“¦ Installing settings.xml..."
              
              # Create .m2 directory
              mkdir -p ~/.m2
              
              # Copy settings.xml
              cp $(mavenSettings.secureFilePath) ~/.m2/settings.xml
              
              # Verify installation
              if [ ! -f ~/.m2/settings.xml ]; then
                echo "âŒ ERROR: settings.xml not found after copy"
                exit 1
              fi
              
              echo "âœ… settings.xml installed"
              echo "Location: ~/.m2/settings.xml"
              echo "Size: $(stat -c%s ~/.m2/settings.xml) bytes"
              echo ""
              
              # Check authentication type
              if grep -q "Bearer" ~/.m2/settings.xml; then
                echo "âœ… Authentication: Bearer Token (Connected App)"
              elif grep -q "<username>" ~/.m2/settings.xml; then
                echo "âš ï¸  Authentication: Username/Password"
              else
                echo "âŒ WARNING: No authentication found!"
              fi
            displayName: 'Install Maven Settings'

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # STEP 5: Cache Maven Dependencies
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          - task: Cache@2
            displayName: 'Cache Maven Dependencies'
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
                maven
              path: $(MAVEN_CACHE_FOLDER)

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # STEP 6: Verify Environment
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          - script: |
              echo "ğŸ” Build Environment Verification"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo ""
              
              echo "=== Java ==="
              java -version 2>&1 | head -3
              echo ""
              
              echo "=== Maven ==="
              export PATH=/opt/maven/bin:$PATH
              /opt/maven/bin/mvn --version
              echo ""
              
              echo "=== Settings.xml ==="
              ls -lh ~/.m2/settings.xml
              echo ""
              
              echo "=== POM Configuration ==="
              if [ -f pom.xml ]; then
                echo "Project:"
                grep -E "<groupId>|<artifactId>|<version>|<packaging>" pom.xml | head -4
                echo ""
                echo "Mule Maven Plugin:"
                grep "mule.maven.plugin.version\|mule-maven-plugin" pom.xml | head -2
              else
                echo "âš ï¸  pom.xml not found"
              fi
              
              echo ""
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "âœ… Environment verification complete"
            displayName: 'Verify Environment'

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # STEP 7: Maven Clean Compile
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          - script: |
              export PATH=/opt/maven/bin:$PATH
              export MAVEN_OPTS="-Xmx3072m"
              
              echo "ğŸ”¨ Running Maven clean compile..."
              echo ""
              
              /opt/maven/bin/mvn clean compile \
                -Dmaven.repo.local=$(MAVEN_CACHE_FOLDER) \
                -Dsecure.key=mule \
                -Dmule.env=dev
              
              echo ""
              echo "âœ… Compile successful"
            displayName: 'Maven Clean Compile'

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # STEP 8: Maven Test (Optional - Uncomment to Enable)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # - script: |
          #     export PATH=/opt/maven/bin:$PATH
          #     export MAVEN_OPTS="-Xmx3072m"
          #     
          #     echo "ğŸ§ª Running MUnit tests..."
          #     
          #     /opt/maven/bin/mvn test \
          #       -Dmaven.repo.local=$(MAVEN_CACHE_FOLDER) \
          #       -Dsecure.key=mule \
          #       -Dmule.env=dev
          #   displayName: 'Maven Test'
          #   continueOnError: true

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # STEP 9: Maven Package
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          - script: |
              export PATH=/opt/maven/bin:$PATH
              export MAVEN_OPTS="-Xmx3072m"
              
              echo "ğŸ“¦ Running Maven package..."
              echo ""
              
              /opt/maven/bin/mvn package \
                -Dmaven.repo.local=$(MAVEN_CACHE_FOLDER) \
                -Dsecure.key=mule \
                -Dmule.env=dev \
                -DskipTests
              
              echo ""
              echo "Checking for build artifacts..."
              if ls target/*.jar 1> /dev/null 2>&1; then
                echo "âœ… Package created successfully:"
                ls -lh target/*.jar
              else
                echo "âŒ ERROR: No JAR file found in target/"
                ls -la target/ 2>/dev/null || echo "target/ directory not found"
                exit 1
              fi
            displayName: 'Maven Package'

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # STEP 10: Copy Build Artifacts
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          - task: CopyFiles@2
            displayName: 'Copy Build Artifacts'
            inputs:
              Contents: |
                **/target/*.jar
                pom.xml
              TargetFolder: $(Build.ArtifactStagingDirectory)
              flattenFolders: false

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # STEP 11: Publish Pipeline Artifacts
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Pipeline Artifacts'
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)
              artifact: 'drop'

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # STEP 12: Build Summary
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          - script: |
              echo ""
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "ğŸ‰ BUILD COMPLETED SUCCESSFULLY"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo ""
              echo "Artifacts:"
              ls -lh target/*.jar 2>/dev/null || echo "No artifacts found"
              echo ""
              echo "Maven Version: 3.9.10"
              echo "Java Version: 17"
              echo "Mule Maven Plugin: 4.6.0"
              echo ""
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            displayName: 'Build Summary'
            condition: succeeded()

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DEPLOY STAGE (Optional - Uncomment to Enable CloudHub Deployment)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # - stage: Deploy
  #   displayName: 'Deploy to CloudHub'
  #   dependsOn: Build
  #   condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  #   jobs:
  #     - deployment: DeployToCloudHub
  #       displayName: 'Deploy to CloudHub Sandbox'
  #       environment: 'Sandbox'
  #       strategy:
  #         runOnce:
  #           deploy:
  #             steps:
  #               # Re-install Maven 3.9.10
  #               - script: |
  #                   wget -q -O /tmp/maven.tar.gz https://archive.apache.org/dist/maven/maven-3/3.9.10/binaries/apache-maven-3.9.10-bin.tar.gz
  #                   sudo rm -rf /opt/maven
  #                   sudo mkdir -p /opt/maven
  #                   sudo tar -xzf /tmp/maven.tar.gz -C /opt/maven --strip-components=1
  #                   rm -f /tmp/maven.tar.gz
  #                 displayName: 'Setup Maven for Deploy'
  #               
  #               # Re-download settings.xml
  #               - task: DownloadSecureFile@1
  #                 name: mavenSettingsDeploy
  #                 inputs:
  #                   secureFile: 'settings.xml'
  #               
  #               - script: |
  #                   mkdir -p ~/.m2
  #                   cp $(mavenSettingsDeploy.secureFilePath) ~/.m2/settings.xml
  #                 displayName: 'Install Maven Settings'
  #               
  #               # Download build artifacts
  #               - download: current
  #                 artifact: drop
  #               
  #               # Deploy to CloudHub
  #               - script: |
  #                   export PATH=/opt/maven/bin:$PATH
  #                   cd $(Pipeline.Workspace)/drop
  #                   
  #                   /opt/maven/bin/mvn deploy \
  #                     -DskipTests \
  #                     -Dmule.version=4.9.0 \
  #                     -Dcloudhub.environment=Sandbox \
  #                     -Danypoint.username=$(anypointUsername) \
  #                     -Danypoint.password=$(anypointPassword)
  #                 displayName: 'Deploy to CloudHub'
