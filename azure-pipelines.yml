# Azure Pipelines YAML for MuleSoft Projects
# ‚úÖ FIXED: Path to settings.xml (removed -s flag, using default location)
# ‚úÖ Java 17 + Mule Maven Plugin 4.6.0
# ‚úÖ Connected App authentication via settings.xml from Secure Files

trigger:
  branches:
    include:
      - '*'

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: build.variables
  - name: disable.coverage.autogenerate
    value: 'true'
  - name: MAVEN_CACHE_FOLDER
    value: $(Pipeline.Workspace)/.m2/repository

stages:
  - stage: Build
    displayName: 'Build and Test Stage'
    jobs:
      - job: BuildAndTest
        displayName: 'Build and Test Job'
        steps:
          # ‚úÖ STEP 1: Download settings.xml from Azure Secure Files
          - task: DownloadSecureFile@1
            name: mavenSettings
            displayName: 'Download Maven Settings from Secure Files'
            inputs:
              secureFile: 'settings.xml'
          
          # ‚úÖ STEP 2: Install settings.xml to Maven directory
          - script: |
              echo "üì¶ Installing Maven settings.xml..."
              mkdir -p ~/.m2
              cp $(mavenSettings.secureFilePath) ~/.m2/settings.xml
              
              echo "‚úÖ settings.xml installed successfully"
              echo "Location: ~/.m2/settings.xml"
              
              # Verify file exists
              if [ -f ~/.m2/settings.xml ]; then
                echo "‚úÖ Verified: settings.xml exists"
                FILE_SIZE=$(stat -c%s ~/.m2/settings.xml)
                echo "File size: $FILE_SIZE bytes"
                echo "Absolute path: $(readlink -f ~/.m2/settings.xml)"
              else
                echo "‚ùå ERROR: settings.xml not found!"
                exit 1
              fi
              
              # Show structure (without credentials)
              echo ""
              echo "Settings.xml structure:"
              echo "Servers configured:"
              grep -A 2 "<server>" ~/.m2/settings.xml | grep "<id>" | sed 's/<[^>]*>//g' | sed 's/^[ \t]*/  - /' || echo "  Could not parse"
              
              # Check authentication type
              if grep -q "Bearer" ~/.m2/settings.xml; then
                echo "Authentication: Bearer Token (Connected App) ‚úÖ"
              elif grep -q "<username>" ~/.m2/settings.xml; then
                echo "Authentication: Username/Password"
              else
                echo "‚ö†Ô∏è WARNING: No authentication found!"
              fi
            displayName: 'Install Maven Settings'

          # ‚úÖ STEP 3: Setup Java 17
          - task: JavaToolInstaller@0
            displayName: 'Install Java 17'
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          # ‚úÖ STEP 4: Cache Maven dependencies
          - task: Cache@2
            displayName: 'Cache Maven Dependencies'
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
                maven
              path: $(MAVEN_CACHE_FOLDER)

          # ‚úÖ STEP 5: Verify Environment
          - script: |
              echo "üîç Verifying build environment..."
              echo "=========================================="
              
              echo ""
              echo "=== Java Version ==="
              java -version
              
              echo ""
              echo "=== Maven Version ==="
              mvn --version
              
              echo ""
              echo "=== Settings Location ==="
              ls -lh ~/.m2/settings.xml
              echo "Absolute path: $(readlink -f ~/.m2/settings.xml)"
              
              echo ""
              echo "=== Home Directory ==="
              echo "HOME=$HOME"
              echo "User: $(whoami)"
              echo "Working directory: $(pwd)"
              
              echo ""
              echo "=== POM Configuration ==="
              if [ -f pom.xml ]; then
                echo "Mule Maven Plugin Version:"
                grep "mule.maven.plugin.version" pom.xml || echo "  Not found"
                echo ""
                echo "Java Compiler Version:"
                grep "maven.compiler.source\|maven.compiler.target" pom.xml || echo "  Not found"
              else
                echo "‚ö†Ô∏è pom.xml not found in current directory"
                pwd
              fi
              
              echo ""
              echo "=========================================="
              echo "‚úÖ Environment verification complete"
            displayName: 'Verify Build Environment'

          # ‚úÖ STEP 6: Maven Validate (test authentication)
          # ‚ö†Ô∏è NO -s flag needed - Maven auto-uses ~/.m2/settings.xml
          - task: Maven@4
            displayName: 'Maven Validate (Test Auth)'
            continueOnError: true
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'validate'
              options: '-X -Dmaven.repo.local=$(MAVEN_CACHE_FOLDER)'
              publishJUnitResults: false
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.17'
              mavenVersionOption: 'Default'
              mavenOptions: '-Xmx3072m'

          # ‚úÖ STEP 7: Maven Clean Compile
          - task: Maven@4
            displayName: 'Maven Clean Compile'
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'clean compile'
              options: '-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER) -Dsecure.key=mule -Dmule.env=dev'
              publishJUnitResults: false
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.17'
              mavenVersionOption: 'Default'
              mavenOptions: '-Xmx3072m'

          # ‚úÖ STEP 8: MUnit Tests (optional - uncomment to enable)
          # - task: Maven@4
          #   displayName: 'MUnit Tests'
          #   continueOnError: true
          #   inputs:
          #     mavenPomFile: 'pom.xml'
          #     goals: 'test'
          #     options: '-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER) -Dsecure.key=mule -Dmule.env=dev'
          #     publishJUnitResults: true
          #     testResultsFiles: '**/surefire-reports/TEST-*.xml'
          #     javaHomeOption: 'JDKVersion'
          #     jdkVersionOption: '1.17'
          #     mavenVersionOption: 'Default'
          #     mavenOptions: '-Xmx3072m'

          # ‚úÖ STEP 9: Maven Package
          - task: Maven@4
            displayName: 'Maven Package'
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'package'
              options: '-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER) -Dsecure.key=mule -Dmule.env=dev -DskipTests'
              publishJUnitResults: false
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.17'
              mavenVersionOption: 'Default'
              mavenOptions: '-Xmx3072m'

          # ‚úÖ STEP 10: Verify Package Created
          - script: |
              echo "üì¶ Verifying package creation..."
              if ls target/*.jar 1> /dev/null 2>&1; then
                echo "‚úÖ Package created successfully:"
                ls -lh target/*.jar
              else
                echo "‚ùå ERROR: No JAR file found in target/"
                ls -la target/ || echo "target/ directory not found"
                exit 1
              fi
            displayName: 'Verify Package'

          # ‚úÖ STEP 11: Copy Build Artifacts
          - task: CopyFiles@2
            displayName: 'Copy Build Artifacts'
            inputs:
              Contents: |
                **/target/*.jar
                pom.xml
              TargetFolder: $(Build.ArtifactStagingDirectory)
              flattenFolders: false

          # ‚úÖ STEP 12: Publish Pipeline Artifacts
          - task: PublishPipelineArtifact@1
            displayName: 'Publish Pipeline Artifacts'
            inputs:
              targetPath: $(Build.ArtifactStagingDirectory)
              artifact: 'drop'

  # ‚úÖ DEPLOY STAGE: CloudHub Deployment (uncomment to enable)
  # - stage: Deploy
  #   displayName: 'Deploy to CloudHub'
  #   dependsOn: Build
  #   condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  #   jobs:
  #     - deployment: DeployToCloudHub
  #       displayName: 'Deploy to CloudHub Sandbox'
  #       environment: 'Sandbox'
  #       strategy:
  #         runOnce:
  #           deploy:
  #             steps:
  #               # Re-download settings.xml
  #               - task: DownloadSecureFile@1
  #                 name: mavenSettingsDeploy
  #                 displayName: 'Download Maven Settings'
  #                 inputs:
  #                   secureFile: 'settings.xml'
                
  #               - script: |
  #                   mkdir -p ~/.m2
  #                   cp $(mavenSettingsDeploy.secureFilePath) ~/.m2/settings.xml
  #                   echo "‚úÖ Settings installed for deployment"
  #                 displayName: 'Install Maven Settings for Deploy'

  #               # Download build artifacts
  #               - download: current
  #                 artifact: drop
  #                 displayName: 'Download Build Artifacts'

  #               # Deploy to CloudHub (no -s flag needed)
  #               - task: Maven@4
  #                 displayName: 'Deploy to CloudHub'
  #                 inputs:
  #                   mavenPomFile: '$(Pipeline.Workspace)/drop/pom.xml'
  #                   goals: 'deploy'
  #                   options: '-DskipTests -Dmule.version=4.9.0 -Dcloudhub.environment=Sandbox -Danypoint.username=$(anypointUsername) -Danypoint.password=$(anypointPassword)'
  #                   publishJUnitResults: false
  #                   javaHomeOption: 'JDKVersion'
  #                   jdkVersionOption: '1.17'
  #                   mavenVersionOption: 'Default'
  #                   mavenOptions: '-Xmx3072m'
